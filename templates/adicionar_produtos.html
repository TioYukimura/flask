<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Adicionar Novo Produto - Vale & Feira</title>

        <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"
            rel="stylesheet"
        />

        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/adicionar_produto.css') }}"
        />
    </head>

    <body>
        <header class="topbar">
            <a href="{{ url_for('main.home') }}" class="logo-container">
                <img
                    src="{{ url_for('static', filename='img/logo.png') }}"
                    class="logo-img"
                    alt="Logo"
                />
                <span class="logo-text">Vale&Feira</span>
            </a>

            <nav class="nav-links">
                <a href="{{ url_for('main.home') }}">In√≠cio</a>
                <a href="{{ url_for('produto.buscar_produtos') }}">Produtos</a>
                <a href="{{ url_for('chat.meus_chats') }}">Conversas</a>
                <nav class="nav-planoslink">
                    <a href="{{ url_for('planos.lista_planos') }}"
                        >üåüPlanosüåü</a
                    >
                </nav>
                <a href="{{ url_for('perfil.perfil') }}">Perfil</a>
                <a href="{{ url_for('auth.logout') }}" class="sair">Sair</a>
            </nav>
        </header>

        <div class="page-header">
            <h1>Adicionar Novo Produto</h1>
            <p>
                Compartilhe seus produtos com toda a comunidade do Vale do
                Jequitinhonha.
            </p>
        </div>

        <main class="container">
            {% if form and form.errors %}
            <div
                style="
                    background: #ffebee;
                    border: 1px solid #ffcdd2;
                    color: #b71c1c;
                    padding: 15px;
                    border-radius: 15px;
                    margin-bottom: 20px;
                "
            >
                <strong>üõë Ops! Verifique os campos abaixo:</strong>
                <ul style="margin-left: 20px; margin-top: 5px">
                    {% for field, errors in form.errors.items() %} {% for error
                    in errors %}
                    <li>{{ error }}</li>
                    {% endfor %} {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="form-card">
                <form
                    method="POST"
                    enctype="multipart/form-data"
                    id="produtoForm"
                >
                    {% if form %} {{ form.hidden_tag() }} {% else %}
                    <input
                        type="hidden"
                        name="csrf_token"
                        value="{{ csrf_token() }}"
                    />
                    {% endif %}

                    <div class="section-title">üë®‚Äçüåæ Dados do Produtor</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome do Produtor/Propriedade *</label>
                            <input
                                type="text"
                                name="nome_produtor"
                                placeholder="Ex: Jo√£o Silva ou S√≠tio Boa Vista"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label>Tempo de Experi√™ncia</label>
                            <select name="tempo_experiencia">
                                <option value="">Selecione</option>
                                <option value="Iniciante">Iniciante</option>
                                <option value="1-2 anos">1-2 anos</option>
                                <option value="Tradi√ß√£o Familiar">
                                    Tradi√ß√£o Familiar
                                </option>
                                <option value="Mais de 10 anos">
                                    Mais de 10 anos
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Cidade/Regi√£o *</label>
                            <input
                                type="text"
                                name="cidadeForm"
                                placeholder="Ex: Diamantina, MG"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label>WhatsApp (Opcional)</label>
                            <input
                                type="tel"
                                name="whatsapp"
                                id="whatsappInput"
                                inputmode="numeric"
                                autocomplete="tel"
                                placeholder="(11) 98888-7777"
                                maxlength="15"
                            />
                            <small class="helper-text">
                                Apenas n√∫meros (11 d√≠gitos). Ex: 11988887777
                            </small>
                        </div>

                        <div class="form-group">
                            <label>E-mail de Contato (Opcional)</label>
                            <input
                                type="email"
                                name="email_contato"
                                id="emailContatoInput"
                                placeholder="contato@exemplo.com"
                                pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$"
                                title="Digite um e-mail v√°lido. Ex: contato@exemplo.com"
                            />
                            <small class="helper-text">
                                Digite um e-mail v√°lido (ex:
                                contato@exemplo.com).
                            </small>
                        </div>

                        <div
                            class="form-group full-width"
                            style="grid-column: span 2"
                        >
                            <label>Hist√≥ria do Produtor (Opcional)</label>
                            <textarea
                                name="historia_produtor"
                                rows="4"
                                placeholder="Conte um pouco sobre quem produz..."
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label
                                for="link_mapa"
                                style="font-weight: bold; color: #2d5a4c"
                            >
                                üìç Localiza√ß√£o no Google Maps (Opcional)
                            </label>
                            <input
                                type="url"
                                class="form-control"
                                id="link_mapa"
                                name="link_mapa"
                                placeholder="Cole o link de compartilhamento do Maps aqui"
                            />
                            <small style="color: #666; font-size: 0.8rem">
                                Dica: Abra o Google Maps, marque seu local,
                                clique em "Compartilhar" e copie o link.
                            </small>
                        </div>
                    </div>

                    <div class="section-title">üõçÔ∏è Informa√ß√µes do Produto</div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Nome do Produto *</label>
                            <input
                                type="text"
                                name="nomeForm"
                                placeholder="Ex: Mel Artesanal do Jequitinhonha"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label>Categoria *</label>
                            <select name="categoriaForm" required>
                                <option value="">Selecione...</option>
                                <option value="Vegetais e Verduras">
                                    Vegetais e Verduras
                                </option>
                                <option value="Frutas Frescas">
                                    Frutas Frescas
                                </option>
                                <option value="Mel e Derivados">
                                    Mel e Derivados
                                </option>
                                <option value="Gr√£os e Cereais">
                                    Gr√£os e Cereais
                                </option>
                                <option value="Queijos e Latic√≠nios">
                                    Queijos e Latic√≠nios
                                </option>
                                <option value="Conservas e Doces">
                                    Conservas e Doces
                                </option>
                                <option value="Artesanato Local">
                                    Artesanato Local
                                </option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Disponibilidade *</label>
                            <select name="disponibilidade" required>
                                <option value="disponivel">
                                    ‚úÖ Dispon√≠vel
                                </option>
                                <option value="sob_encomenda">
                                    üì¶ Sob Encomenda
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Quantidade Dispon√≠vel *</label>
                            <input
                                type="number"
                                name="quantidade"
                                placeholder="Ex: 10"
                                min="1"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label>Unidade de Medida *</label>
                            <select name="unidade" required>
                                <option value="">Selecione...</option>
                                <option value="Quilograma">
                                    Quilograma (kg)
                                </option>
                                <option value="Grama">Grama (g)</option>
                                <option value="Litro">Litro (L)</option>
                                <option value="Mililitro">
                                    Mililitro (ml)
                                </option>
                                <option value="Unidade">Unidade</option>
                                <option value="Ma√ßo">Ma√ßo</option>
                                <option value="Caixa">Caixa</option>
                                <option value="Saca">Saca</option>
                                <option value="Duzia">D√∫zia</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label>Descri√ß√£o Detalhada *</label>
                            <textarea
                                name="descricaoForm"
                                rows="4"
                                placeholder="Descreva seu produto..."
                                required
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label>Pre√ßo (R$) *</label>
                            <input
                                type="text"
                                id="precoInput"
                                name="precoForm"
                                placeholder="0,00"
                                required
                            />
                        </div>

                        <div class="form-group full-width">
                            <label>Fotos do Produto *</label>
                            <input
                                type="file"
                                id="imagensInput"
                                name="imagens"
                                accept="image/*"
                                multiple
                                required
                            />
                            <small class="helper-text">
                                Dica: voc√™ pode selecionar v√°rias fotos
                                (Ctrl/Shift).
                            </small>

                            <div class="preview-wrap" id="previewWrap">
                                <div class="preview-title">
                                    üñºÔ∏è Pr√©via das fotos selecionadas
                                </div>
                                <div
                                    class="preview-grid"
                                    id="previewGrid"
                                ></div>
                                <div class="preview-hint">
                                    Voc√™ pode remover uma foto clicando no ‚Äú√ó‚Äù
                                    em cima dela.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">üè∑Ô∏è Caracter√≠sticas</div>
                    <div class="characteristics-grid">
                        <label class="check-item">
                            <input
                                type="checkbox"
                                name="caracteristicas"
                                value="üåø Org√¢nico"
                            />
                            üåø Org√¢nico
                        </label>

                        <label class="check-item">
                            <input
                                type="checkbox"
                                name="caracteristicas"
                                value="üèÜ Artesanal"
                            />
                            üèÜ Artesanal
                        </label>

                        <label class="check-item">
                            <input
                                type="checkbox"
                                name="caracteristicas"
                                value="üå± Fresco"
                            />
                            üå± Fresco
                        </label>

                        <label class="check-item">
                            <input
                                type="checkbox"
                                name="caracteristicas"
                                value="üè† Local"
                            />
                            üè† Local
                        </label>

                        <label class="check-item">
                            <input
                                type="checkbox"
                                name="caracteristicas"
                                value="‚ôªÔ∏è Sustent√°vel"
                            />
                            ‚ôªÔ∏è Sustent√°vel
                        </label>

                        <label class="check-item">
                            <input
                                type="checkbox"
                                name="caracteristicas"
                                value="üìú Tradicional"
                            />
                            üìú Tradicional
                        </label>
                    </div>

                    <div class="action-btns">
                        <button type="submit" class="btn-publish">
                            Publicar Produto
                        </button>
                    </div>
                </form>

                <div class="tips-box">
                    <div class="tip-item">
                        <span class="tip-icon">üì∏</span>
                        <strong>Fotos:</strong> Use fotos claras.
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">üí∞</span>
                        <strong>Pre√ßo:</strong> Pre√ßo justo atrai mais.
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>Vale&Feira</h4>
                    <p>
                        Conectando produtores e consumidores atrav√©s da
                        tecnologia e sustentabilidade.
                    </p>
                </div>

                <div class="footer-col">
                    <h4>Links R√°pidos</h4>
                    <a href="{{ url_for('main.home') }}">In√≠cio</a>
                    <a href="{{ url_for('produto.buscar_produtos') }}"
                        >Produtos</a
                    >
                    <a href="{{ url_for('produto.adicionar_produtos') }}"
                        >Adicionar Produto</a
                    >
                    <a href="{{ url_for('chat.meus_chats') }}">Conversas</a>
                    {% if not current_user.is_authenticated %}
                    <a href="{{ url_for('auth.registrar') }}">Cadastrar</a>
                    {% endif %}
                </div>

                <div class="footer-col">
                    <h4>Suporte/Ajuda</h4>
                    <a href="{{ url_for('main.relatar_bug_page') }}"
                        >Central de Ajuda</a
                    >
                    <a href="#" onclick="abrirModalTermos(); return false;"
                        >Termos de Uso</a
                    >
                </div>

                <div class="footer-col">
                    <h4>Contatos</h4>
                    <a>üìßcontato@valefeira.com.br</a>
                    <a>üìßsuportevaleefeira@gmail.com</a>
                    <a href="#">üì± (38) 3333-4444</a>
                    <p>üìç Vale do Jequitinhonha, MG</p>
                </div>
            </div>

            <div class="footer-bottom">
                &copy; 2026 Vale&Feira. Todos os direitos reservados.
            </div>
        </footer>

        <div id="modalTermos" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="fecharModalTermos()"
                    >&times;</span
                >
                <div class="modal-body">
                    <h3>Termos e Condi√ß√µes de Uso</h3>

                    <h4>1. Objeto e Defini√ß√£o</h4>
                    <p>
                        A plataforma Vale & Feira √© um ambiente digital
                        destinado √† divulga√ß√£o, promo√ß√£o e facilita√ß√£o da
                        comercializa√ß√£o de produtos cultivados e produzidos no
                        Vale do Jequitinhonha. O site atua como uma "feira
                        virtual", conectando produtores locais (agricultores
                        familiares e artes√£os) a potenciais compradores.
                    </p>

                    <div style="text-align: center; margin-top: 20px">
                        <button
                            class="btn-modal-close"
                            onclick="fecharModalTermos()"
                        >
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function abrirModalTermos() {
                document.getElementById("modalTermos").style.display = "flex";
            }
            function fecharModalTermos() {
                document.getElementById("modalTermos").style.display = "none";
            }
            window.onclick = function (event) {
                if (event.target == document.getElementById("modalTermos")) {
                    fecharModalTermos();
                }
            };

            const imagensInput = document.getElementById("imagensInput");
            const previewWrap = document.getElementById("previewWrap");
            const previewGrid = document.getElementById("previewGrid");
            const produtoForm = document.getElementById("produtoForm");

            let arquivosSelecionados = [];

            function atualizarInputFiles() {
                const dt = new DataTransfer();
                arquivosSelecionados.forEach((f) => dt.items.add(f));
                imagensInput.files = dt.files;
            }

            function renderPreview() {
                previewGrid.innerHTML = "";

                if (!arquivosSelecionados.length) {
                    previewWrap.style.display = "none";
                    return;
                }

                previewWrap.style.display = "block";

                arquivosSelecionados.forEach((file, index) => {
                    const item = document.createElement("div");
                    item.className = "preview-item";

                    const img = document.createElement("img");
                    img.alt = "Pr√©via da foto";
                    img.src = URL.createObjectURL(file);

                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "remove-preview";
                    btn.textContent = "√ó";
                    btn.title = "Remover esta foto";
                    btn.onclick = () => {
                        arquivosSelecionados.splice(index, 1);
                        atualizarInputFiles();
                        renderPreview();
                    };

                    item.appendChild(img);
                    item.appendChild(btn);
                    previewGrid.appendChild(item);
                });
            }

            imagensInput.addEventListener("change", (e) => {
                const novos = Array.from(e.target.files || []);
                arquivosSelecionados = novos;
                atualizarInputFiles();
                renderPreview();
            });

            const whatsappInput = document.getElementById("whatsappInput");
            const emailContatoInput =
                document.getElementById("emailContatoInput");

            function pegarApenas11Digitos(valor) {
                return (valor || "").replace(/\D/g, "").slice(0, 11);
            }

            function aplicarMascaraTelefoneBR(digits11) {
                const d = (digits11 || "").slice(0, 11);
                const dd = d.slice(0, 2);
                const parte1 = d.slice(2, 7);
                const parte2 = d.slice(7, 11);

                if (d.length <= 2) return dd ? `(${dd}` : "";
                if (d.length <= 7) return `(${dd}) ${d.slice(2)}`;
                return `(${dd}) ${parte1}-${parte2}`;
            }

            if (whatsappInput) {
                whatsappInput.addEventListener("input", () => {
                    const digits = pegarApenas11Digitos(whatsappInput.value);
                    whatsappInput.value = aplicarMascaraTelefoneBR(digits);
                });

                whatsappInput.addEventListener("paste", (e) => {
                    e.preventDefault();
                    const texto =
                        (e.clipboardData || window.clipboardData).getData(
                            "text",
                        ) || "";
                    const digits = pegarApenas11Digitos(texto);
                    whatsappInput.value = aplicarMascaraTelefoneBR(digits);
                });

                whatsappInput.addEventListener("keydown", (e) => {
                    const liberadas = [
                        "Backspace",
                        "Delete",
                        "ArrowLeft",
                        "ArrowRight",
                        "Tab",
                        "Home",
                        "End",
                    ];
                    if (liberadas.includes(e.key)) return;
                    if (/^\d$/.test(e.key)) return;
                    e.preventDefault();
                });
            }

            produtoForm.addEventListener("submit", (e) => {
                if (!imagensInput.files || imagensInput.files.length === 0) {
                    e.preventDefault();
                    alert("Selecione pelo menos uma foto do produto.");
                    return;
                }

                if (whatsappInput && whatsappInput.value) {
                    const digits = pegarApenas11Digitos(whatsappInput.value);

                    if (digits.length > 0 && digits.length < 11) {
                        e.preventDefault();
                        alert(
                            "O WhatsApp precisa ter 11 n√∫meros (DDD + n√∫mero). Ex: 11988887777",
                        );
                        return;
                    }

                    whatsappInput.value = digits;
                }

                if (emailContatoInput && emailContatoInput.value) {
                    if (!emailContatoInput.checkValidity()) {
                        e.preventDefault();
                        alert(
                            "Digite um e-mail v√°lido. Ex: contato@exemplo.com",
                        );
                        emailContatoInput.focus();
                        return;
                    }
                }
            });
        </script>
    </body>
</html>
