<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Minhas Conversas - Vale & Feira</title>

        <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"
            rel="stylesheet"
        />

        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/meus_chats.css') }}"
        />
    </head>

    <body>
        <header class="topbar">
            <a href="{{ url_for('main.home') }}" class="logo-container">
                <img
                    src="{{ url_for('static', filename='img/logo.png') }}"
                    class="logo-img"
                    alt="Logo"
                />
                <span class="logo-text">Vale&Feira</span>
            </a>

            <nav class="nav-links">
                <a href="{{ url_for('main.home') }}">In√≠cio</a>
                <a href="{{ url_for('produto.buscar_produtos') }}">Produtos</a>

                <a href="{{ url_for('chat.meus_chats') }}">
                    Conversas {% if mensagens_nao_lidas is defined and
                    mensagens_nao_lidas > 0 %}
                    <span class="bolinha-notificacao"
                        >{{ mensagens_nao_lidas }}</span
                    >
                    {% endif %}
                </a>

                <nav class="nav-planoslink">
                    <a href="{{ url_for('planos.lista_planos') }}"
                        >üåüPlanosüåü</a
                    >
                </nav>

                <a href="{{ url_for('perfil.perfil') }}">Perfil</a>
                <a href="{{ url_for('auth.logout') }}" class="link-sair"
                    >Sair</a
                >
            </nav>
        </header>

        <main class="container">
            <div class="header-section">
                <h2>üí¨ Minhas Conversas</h2>
                <a href="{{ url_for('main.home') }}" class="btn-voltar-home"
                    >üè† Voltar ao In√≠cio</a
                >
            </div>

            <div class="lista-conversas">
                {% if chats %} {% for chat in chats %}
                <div class="card-wrapper">
                    <a
                        href="{{ url_for('chat.chat', produto_id=chat.produto.id, outro_usuario_id=chat.outro_usuario.id) }}"
                        class="card-conversa"
                    >
                        <div class="user-avatar-list">
                            {% if chat.outro_usuario.foto_perfil and
                            chat.outro_usuario.foto_perfil !=
                            'default_profile.png' %}
                            <img
                                src="{{ url_for('static', filename='uploads/' + chat.outro_usuario.foto_perfil) }}"
                                alt="Foto de {{ chat.outro_usuario.nome }}"
                                loading="lazy"
                            />
                            {% else %}
                            <span class="avatar-fallback" aria-hidden="true"
                                >üë§</span
                            >
                            {% endif %}
                        </div>

                        <div class="info-conversa">
                            <span class="nome-produto"
                                >{{ chat.produto.nome }}</span
                            >
                            <span class="nome-usuario"
                                >Vendedor: {{ chat.outro_usuario.nome }}</span
                            >

                            <span class="ultima-msg">
                                {% if chat.ultima_mensagem %} {{
                                chat.ultima_mensagem.mensagem|truncate(50) }} {%
                                else %} Nenhuma mensagem ainda. {% endif %}
                            </span>
                        </div>

                        <div class="meta-conversa">
                            <span class="data-msg">
                                {% if chat.ultima_mensagem %} {{
                                chat.ultima_mensagem.data_criacao.strftime('%d/%m
                                %H:%M') }} {% endif %}
                            </span>

                            {% if chat.nao_lidas > 0 %}
                            <span class="badge-notificacao"
                                >{{ chat.nao_lidas }} nova(s)</span
                            >
                            {% endif %}
                        </div>
                    </a>

                    <div class="menu-wrapper">
                        <button
                            type="button"
                            class="btn-menu"
                            aria-label="Op√ß√µes do chat"
                            aria-expanded="false"
                            data-menu-id="menu-{{ chat.produto.id }}-{{ chat.outro_usuario.id }}"
                        >
                            ‚ãÆ
                        </button>

                        <div
                            class="menu-dropdown"
                            id="menu-{{ chat.produto.id }}-{{ chat.outro_usuario.id }}"
                        >
                            <form
                                method="POST"
                                action="{{ url_for('chat.excluir_chat', produto_id=chat.produto.id, outro_usuario_id=chat.outro_usuario.id) }}"
                                onsubmit="return confirm('Tem certeza que deseja excluir esta conversa?');"
                            >
                                {% if csrf_token is defined %}
                                <input
                                    type="hidden"
                                    name="csrf_token"
                                    value="{{ csrf_token() }}"
                                />
                                {% endif %}

                                <button type="submit" class="menu-item danger">
                                    üóë Excluir chat
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %} {% else %}
                <div class="estado-vazio">
                    <p class="estado-vazio-texto">
                        Voc√™ ainda n√£o possui conversas ativas.
                    </p>
                    <a
                        href="{{ url_for('produto.buscar_produtos') }}"
                        class="btn-explorar"
                    >
                        Explorar Produtos
                    </a>
                </div>
                {% endif %}
            </div>
        </main>

        <footer class="footer">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>Vale&Feira</h4>
                    <p>
                        Conectando produtores e consumidores atrav√©s da
                        tecnologia e sustentabilidade.
                    </p>
                </div>

                <div class="footer-col">
                    <h4>Links R√°pidos</h4>
                    <a href="{{ url_for('main.home') }}">In√≠cio</a>
                    <a href="{{ url_for('produto.buscar_produtos') }}"
                        >Produtos</a
                    >
                    <a href="{{ url_for('produto.adicionar_produtos') }}"
                        >Adicionar Produto</a
                    >
                    <a href="{{ url_for('chat.meus_chats') }}">Conversas</a>
                    {% if not current_user.is_authenticated %}
                    <a href="{{ url_for('auth.registrar') }}">Cadastrar</a>
                    {% endif %}
                </div>

                <div class="footer-col">
                    <h4>Suporte/Ajuda</h4>
                    <a href="{{ url_for('main.relatar_bug_page') }}"
                        >Central de Ajuda</a
                    >
                    <a href="#" onclick="abrirModalTermos(); return false;"
                        >Termos de Uso</a
                    >
                </div>

                <div class="footer-col">
                    <h4>Contatos</h4>
                    <a>üìßcontato@valefeira.com.br </a>
                    <a>üìßsuportevaleefeira@gmail.com</a>
                    <a href="#">üì± (38) 3333-4444</a>
                    <p>üìç Vale do Jequitinhonha, MG</p>
                </div>
            </div>

            <div class="footer-bottom">
                &copy; 2026 Vale&Feira. Todos os direitos reservados.
            </div>
        </footer>

        <div id="modalTermos" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="fecharModalTermos()"
                    >&times;</span
                >
                <div class="modal-body">
                    <h3>Termos e Condi√ß√µes de Uso</h3>

                    <h4>1. Objeto e Defini√ß√£o</h4>
                    <p>
                        A plataforma Vale & Feira √© um ambiente digital
                        destinado √† divulga√ß√£o, promo√ß√£o e facilita√ß√£o da
                        comercializa√ß√£o de produtos cultivados e produzidos no
                        Vale do Jequitinhonha. O site atua como uma "feira
                        virtual", conectando produtores locais (agricultores
                        familiares e artes√£os) a potenciais compradores.
                    </p>

                    <h4>2. Natureza do Servi√ßo (Intermedia√ß√£o de Contato)</h4>
                    <ul>
                        <li>
                            <strong>Divulga√ß√£o:</strong> A plataforma oferece
                            espa√ßo para que o produtor cadastre produtos com
                            fotos, descri√ß√£o e pre√ßo.
                        </li>
                        <li>
                            <strong>Aus√™ncia de Intermedi√°rios:</strong> O Vale
                            & Feira n√£o realiza a venda direta nem processa
                            pagamentos (nesta vers√£o MVP). A plataforma facilita
                            o contato via WhatsApp ou e-mail, sendo a transa√ß√£o
                            comercial de inteira responsabilidade das partes
                            envolvidas.
                        </li>
                    </ul>

                    <h4>3. Responsabilidades do Produtor (Vendedor)</h4>
                    <p>
                        Ao cadastrar um produto, o usu√°rio produtor garante que:
                    </p>
                    <ul>
                        <li>
                            As informa√ß√µes sobre o produto (origem, peso, tipo
                            de cultivo) s√£o verdadeiras.
                        </li>
                        <li>
                            As imagens postadas correspondem fielmente ao
                            produto ofertado.
                        </li>
                        <li>
                            Possui autoriza√ß√£o legal para comercializar os itens
                            listados.
                        </li>
                        <li>
                            Compromete-se a manter seus dados de contato
                            atualizados para viabilizar a negocia√ß√£o.
                        </li>
                    </ul>

                    <h4>4. Responsabilidades do Consumidor (Comprador)</h4>
                    <p>
                        O usu√°rio interessado em adquirir produtos reconhece
                        que:
                    </p>
                    <ul>
                        <li>
                            A plataforma n√£o garante a log√≠stica de entrega, que
                            deve ser combinada diretamente com o produtor.
                        </li>
                        <li>
                            A verifica√ß√£o da qualidade e proced√™ncia do produto
                            no ato da entrega √© de sua responsabilidade.
                        </li>
                    </ul>

                    <h4>5. Propriedade Intelectual e Identidade Regional</h4>
                    <p>
                        Todo o conte√∫do institucional, logotipos e a estrutura
                        do site s√£o de propriedade da Equipe de Desenvolvimento
                        Vale & Feira. A plataforma visa valorizar as tradi√ß√µes e
                        a identidade do Vale do Jequitinhonha; portanto, o uso
                        indevido da marca para fins que n√£o o apoio ao produtor
                        local √© proibido.
                    </p>

                    <h4>6. Limita√ß√£o de Responsabilidade</h4>
                    <p>A equipe Vale & Feira n√£o se responsabiliza por:</p>
                    <ul>
                        <li>
                            Negocia√ß√µes frustradas ou n√£o concretizadas entre
                            usu√°rios.
                        </li>
                        <li>
                            Diverg√™ncias de pre√ßos ou qualidade de produtos.
                        </li>
                        <li>
                            Eventuais problemas no transporte ou perecibilidade
                            de alimentos ap√≥s a sa√≠da da propriedade rural.
                        </li>
                    </ul>

                    <h4>7. Prote√ß√£o de Dados (LGPD)</h4>
                    <p>
                        Em conformidade com a Lei Geral de Prote√ß√£o de Dados, os
                        dados coletados (nome, e-mail, telefone e localiza√ß√£o)
                        ser√£o utilizados exclusivamente para:
                    </p>
                    <ul>
                        <li>
                            Cria√ß√£o do perfil de usu√°rio e autentica√ß√£o
                            (Flask-Login).
                        </li>
                        <li>
                            Exibi√ß√£o p√∫blica (no caso de produtores) para
                            viabilizar o contato comercial.
                        </li>
                        <li>
                            Seguran√ßa da plataforma contra acessos indevidos.
                        </li>
                    </ul>

                    <h4>8. Canal de √âtica e Den√∫ncias</h4>
                    <p>
                        Reservamo-nos o direito de remover an√∫ncios ou suspender
                        contas que apresentem comportamentos abusivos,
                        informa√ß√µes falsas ou que desrespeitem os princ√≠pios da
                        agricultura familiar e economia solid√°ria da regi√£o.
                    </p>

                    <div class="modal-actions">
                        <button
                            class="btn-modal-close"
                            onclick="fecharModalTermos()"
                        >
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function abrirModalTermos() {
                document.getElementById("modalTermos").style.display = "flex";
            }
            function fecharModalTermos() {
                document.getElementById("modalTermos").style.display = "none";
            }
            window.onclick = function (event) {
                if (event.target == document.getElementById("modalTermos"))
                    fecharModalTermos();
            };

            function closeAllMenus() {
                document.querySelectorAll(".menu-dropdown").forEach((m) => {
                    m.classList.remove("open");
                });
                document.querySelectorAll(".btn-menu").forEach((b) => {
                    b.setAttribute("aria-expanded", "false");
                });
            }

            document.addEventListener("click", function (e) {
                const btn = e.target.closest(".btn-menu");
                const menu = e.target.closest(".menu-dropdown");

                if (btn) {
                    e.preventDefault();
                    e.stopPropagation();

                    const id = btn.getAttribute("data-menu-id");
                    const dropdown = document.getElementById(id);

                    document.querySelectorAll(".menu-dropdown").forEach((m) => {
                        if (m !== dropdown) m.classList.remove("open");
                    });
                    document.querySelectorAll(".btn-menu").forEach((b) => {
                        if (b !== btn) b.setAttribute("aria-expanded", "false");
                    });

                    if (dropdown) {
                        const willOpen = !dropdown.classList.contains("open");
                        dropdown.classList.toggle("open", willOpen);
                        btn.setAttribute(
                            "aria-expanded",
                            willOpen ? "true" : "false",
                        );
                    }
                    return;
                }

                if (menu) return;

                closeAllMenus();
            });
        </script>
    </body>
</html>
