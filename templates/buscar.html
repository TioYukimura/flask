<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Buscar Produtos - Vale & Feira</title>

        <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"
            rel="stylesheet"
        />

        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/buscar_produtos.css') }}"
        />
    </head>

    <body>
        <header class="barra-topo">
            <a href="{{ url_for('main.home') }}" class="container-logo">
                <img
                    src="{{ url_for('static', filename='img/logo.png') }}"
                    class="imagem-logo"
                    alt="Logo"
                />
                <span class="texto-logo">Vale&Feira</span>
            </a>

            <div class="barra-busca">
                <form method="get" action="{{ url_for('produto.buscar_produtos') }}">
                    <input
                        type="text"
                        name="q"
                        placeholder="Buscar produto..."
                        value="{{ busca|default('') }}"
                    />
                    <button type="submit">Buscar</button>
                </form>
            </div>

            <nav class="links-navegacao">
                <a href="{{ url_for('main.home') }}">In√≠cio</a>
                <a href="{{ url_for('produto.buscar_produtos') }}">Produtos</a>

                {% if current_user.is_authenticated %}
                <a href="{{ url_for('chat.meus_chats') }}">
                    Conversas
                    {% if mensagens_nao_lidas is defined and mensagens_nao_lidas > 0 %}
                    <span class="bolinha-notificacao">{{ mensagens_nao_lidas }}</span>
                    {% endif %}
                </a>

                <nav class="link-planos">
                    <a href="{{ url_for('planos.lista_planos') }}">üåüPlanosüåü</a>
                </nav>

                <a href="{{ url_for('perfil.perfil') }}">Perfil</a>
                <a href="{{ url_for('auth.logout') }}" class="link-sair">Sair</a>
                {% else %}
                <a href="{{ url_for('auth.login') }}" class="botao-login">Login</a>
                <a href="{{ url_for('auth.registrar') }}" class="botao-cadastro">Cadastrar</a>
                {% endif %}
            </nav>
        </header>

        <main class="conteudo">
            <div class="area-controle-filtros">
                <button class="botao-abrir-filtros" onclick="toggleFiltros()">
                    üîç Filtrar
                </button>

                {% if request.args.get('categoria') or request.args.get('min_price') or request.args.get('max_price') or request.args.get('cidade') %}
                <a
                    href="{{ url_for('produto.buscar_produtos', q=busca) }}"
                    class="link-limpar-filtros"
                >
                    Limpar filtros ‚úï
                </a>
                {% endif %}
            </div>

            <div
                id="painelFiltros"
                class="painel-filtros {% if request.args.get('categoria') or request.args.get('min_price') or request.args.get('max_price') or request.args.get('cidade') %}aberto{% endif %}"
            >
                <form action="{{ url_for('produto.buscar_produtos') }}" method="GET">
                    <input type="hidden" name="q" value="{{ busca }}" />

                    <div class="grade-filtros">
                        <div>
                            <label class="rotulo-filtro">Pre√ßo (R$)</label>
                            <div class="linha-campos-preco">
                                <input
                                    type="number"
                                    name="min_price"
                                    class="campo-filtro"
                                    placeholder="M√≠n"
                                    value="{{ request.args.get('min_price', '') }}"
                                />
                                <input
                                    type="number"
                                    name="max_price"
                                    class="campo-filtro"
                                    placeholder="M√°x"
                                    value="{{ request.args.get('max_price', '') }}"
                                />
                            </div>
                        </div>

                        <div>
                            <label class="rotulo-filtro">Categoria</label>
                            <select name="categoria" class="campo-filtro">
                                <option value="">Todas</option>
                                <option value="Vegetais e Verduras" {% if request.args.get('categoria') == 'Vegetais e Verduras' %}selected{% endif %}>Vegetais e Verduras</option>
                                <option value="Frutas Frescas" {% if request.args.get('categoria') == 'Frutas Frescas' %}selected{% endif %}>Frutas Frescas</option>
                                <option value="Mel e Derivados" {% if request.args.get('categoria') == 'Mel e Derivados' %}selected{% endif %}>Mel e Derivados</option>
                                <option value="Gr√£os e Cereais" {% if request.args.get('categoria') == 'Gr√£os e Cereais' %}selected{% endif %}>Gr√£os e Cereais</option>
                                <option value="Queijos e Latic√≠nios" {% if request.args.get('categoria') == 'Queijos e Latic√≠nios' %}selected{% endif %}>Queijos e Latic√≠nios</option>
                                <option value="Conservas e Doces" {% if request.args.get('categoria') == 'Conservas e Doces' %}selected{% endif %}>Conservas e Doces</option>
                                <option value="Artesanato Local" {% if request.args.get('categoria') == 'Artesanato Local' %}selected{% endif %}>Artesanato Local</option>
                            </select>
                        </div>

                        <div>
                            <label class="rotulo-filtro">Cidade</label>
                            <input
                                type="text"
                                name="cidade"
                                class="campo-filtro"
                                placeholder="Ex: Diamantina"
                                value="{{ request.args.get('cidade', '') }}"
                            />
                        </div>

                        <button type="submit" class="botao-aplicar">Aplicar</button>
                    </div>
                </form>
            </div>

            {% if produtos %}
                {% set premium = [] %}
                {% set produtor = [] %}
                {% set basico = [] %}

                {% for p in produtos %}
                    {% set plano_id = 0 %}
                    {% if p.dono %}
                        {% set assinatura = p.dono.assinatura_atual() %}
                        {% if assinatura %}
                            {% set plano_id = assinatura.plano_id %}
                        {% endif %}
                    {% endif %}

                    {% if p.destaque %}
                        {% if plano_id == 3 %}
                            {% set _ = premium.append(p) %}
                        {% elif plano_id == 2 %}
                            {% set _ = produtor.append(p) %}
                        {% elif plano_id == 1 %}
                            {% set _ = basico.append(p) %}
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% set produtos_destaque = premium + produtor + basico %}

                {% if produtos_destaque %}
                <section class="secao-destaque">
                    <h2 class="titulo-destaque">‚≠ê Produtos em Destaque ‚≠ê</h2>

                    <div class="grade-produtos">
                        {% for produto in produtos_destaque %}
                        <div class="card-produto card-destaque">
                            <div class="area-imagem-card">
                                {% if produto.imagem %}
                                    {% if produto.imagem.startswith('http') %}
                                        {% set final_url = produto.imagem %}
                                    {% else %}
                                        {% set final_url = url_for('static', filename=produto.imagem) %}
                                    {% endif %}
                                {% else %}
                                    {% set final_url = url_for('static', filename='img/sem_imagem.png') %}
                                {% endif %}

                                <img
                                    src="{{ final_url }}"
                                    alt="{{ produto.nome }}"
                                    onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/sem_imagem.png') }}';"
                                />
                            </div>

                            <div class="badges-abaixo-imagem">
                                <span class="badge-categoria">{{ produto.categoria or 'Geral' }}</span>
                                {% if produto.disponibilidade == 'sob_encomenda' %}
                                    <span class="badge-disponibilidade laranja">üì¶ Sob Encomenda</span>
                                {% else %}
                                    <span class="badge-disponibilidade verde">‚úÖ Dispon√≠vel</span>
                                {% endif %}
                            </div>

                            <h3>{{ produto.nome }}</h3>

                            <div class="info-produtor">
                                üë§ {{ produto.nome_produtor if produto.nome_produtor else (produto.dono.nome if produto.dono else 'Produtor Local') }}
                                {% if produto.cidade %} ‚Ä¢ Cidade: {{ produto.cidade }}{% endif %}
                            </div>

                            <div class="container-preco">
                                <span class="preco-novo">
                                    R$ {{ "%.2f"|format(produto.preco) }}{% if produto.unidade %} / {{ produto.unidade }}{% endif %}
                                </span>

                                {% if produto.media_notas > 0 %}
                                <span class="avaliacao-inline">
                                    <span class="estrela">‚òÖ</span>
                                    <span class="nota">{{ produto.media_notas }}</span>
                                    <span class="qtd">({{ produto.total_avaliacoes }})</span>
                                </span>
                                {% else %}
                                <span class="tag-novo">Novo</span>
                                {% endif %}
                            </div>

                            {% if current_user.is_authenticated %}
                                {% if current_user.id != produto.usuario_id %}
                                <a
                                    href="{{ url_for('chat.chat', produto_id=produto.id, outro_usuario_id=produto.usuario_id) }}"
                                    class="botao-conversa"
                                >
                                    üí¨ Conversar com o Produtor
                                </a>
                                {% else %}
                                <span class="botao-conversa desabilitado">Seu Produto</span>
                                {% endif %}
                            {% else %}
                            <a href="{{ url_for('auth.login') }}" class="botao-conversa">üîí Login</a>
                            {% endif %}

                            <a
                                href="{{ url_for('produto.pagina_produto', id=produto.id) }}"
                                class="botao-detalhes"
                            >
                                Ver Detalhes
                            </a>

                            <a
                                href="{{ url_for('main.denunciar_produto_page', produto_id=produto.id) }}"
                                class="botao-denunciar"
                            >
                                ‚ö†Ô∏è Denunciar An√∫ncio
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
            {% endif %}

            <h2 class="titulo-resultados">Todos os Resultados</h2>

            <div class="grade-produtos">
                {% if produtos %}
                    {% for produto in produtos %}
                    <div class="card-produto">
                        <div class="area-imagem-card">
                            {% if produto.imagem %}
                                {% if produto.imagem.startswith('http') %}
                                    {% set final_url = produto.imagem %}
                                {% else %}
                                    {% set final_url = url_for('static', filename=produto.imagem) %}
                                {% endif %}
                            {% else %}
                                {% set final_url = url_for('static', filename='img/sem_imagem.png') %}
                            {% endif %}

                            <img
                                src="{{ final_url }}"
                                alt="{{ produto.nome }}"
                                onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/sem_imagem.png') }}';"
                            />
                        </div>

                        <div class="badges-abaixo-imagem">
                            <span class="badge-categoria">{{ produto.categoria or 'Geral' }}</span>
                            {% if produto.disponibilidade == 'sob_encomenda' %}
                                <span class="badge-disponibilidade laranja">üì¶ Sob Encomenda</span>
                            {% else %}
                                <span class="badge-disponibilidade verde">‚úÖ Dispon√≠vel</span>
                            {% endif %}
                        </div>

                        <h3>{{ produto.nome }}</h3>

                        <div class="info-produtor">
                            üë§ {{ produto.nome_produtor if produto.nome_produtor else (produto.dono.nome if produto.dono else 'Produtor Local') }}
                            {% if produto.cidade %} ‚Ä¢ Cidade: {{ produto.cidade }}{% endif %}
                        </div>

                        <div class="container-preco">
                            <div class="linha-preco">
                                {% if produto.desconto and produto.desconto > 0 %}
                                    {% set preco_antigo = produto.preco / (1 - (produto.desconto / 100)) %}
                                    <span class="preco-antigo">R$ {{ "%.2f"|format(preco_antigo) }}</span>
                                    <span class="preco-novo">
                                        R$ {{ "%.2f"|format(produto.preco) }}{% if produto.unidade %} / {{ produto.unidade }}{% endif %}
                                    </span>
                                    <span class="tag-desconto">-{{ produto.desconto }}%</span>
                                {% else %}
                                    <span class="preco-novo">
                                        R$ {{ "%.2f"|format(produto.preco) }}{% if produto.unidade %} / {{ produto.unidade }}{% endif %}
                                    </span>
                                {% endif %}
                            </div>

                            {% if produto.media_notas > 0 %}
                            <span class="avaliacao-inline">
                                <span class="estrela">‚òÖ</span>
                                <span class="nota">{{ produto.media_notas }}</span>
                                <span class="qtd">({{ produto.total_avaliacoes }})</span>
                            </span>
                            {% else %}
                            <span class="tag-novo">Novo</span>
                            {% endif %}
                        </div>

                        {% if current_user.is_authenticated %}
                            {% if current_user.id != produto.usuario_id %}
                            <a
                                href="{{ url_for('chat.chat', produto_id=produto.id, outro_usuario_id=produto.usuario_id) }}"
                                class="botao-conversa"
                            >
                                üí¨ Conversar com o Produtor
                            </a>
                            {% else %}
                            <span class="botao-conversa desabilitado">Seu Produto</span>
                            {% endif %}
                        {% else %}
                        <a href="{{ url_for('auth.login') }}" class="botao-conversa">üîí Login</a>
                        {% endif %}

                        <a
                            href="{{ url_for('produto.pagina_produto', id=produto.id) }}"
                            class="botao-detalhes"
                        >
                            Ver Detalhes
                        </a>

                        <a
                            href="{{ url_for('main.denunciar_produto_page', produto_id=produto.id) }}"
                            class="botao-denunciar"
                        >
                            ‚ö†Ô∏è Denunciar An√∫ncio
                        </a>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="estado-vazio">
                    <p>Nenhum produto encontrado para sua busca.</p>
                    <a href="{{ url_for('main.home') }}">Ver todos os produtos ‚Üí</a>
                </div>
                {% endif %}
            </div>
        </main>

        <footer class="rodape">
            <div class="grade-rodape">
                <div class="coluna-rodape">
                    <h4>Vale&Feira</h4>
                    <p>
                        Conectando produtores e consumidores atrav√©s da
                        tecnologia e sustentabilidade.
                    </p>
                </div>

                <div class="coluna-rodape">
                    <h4>Links R√°pidos</h4>
                    <a href="{{ url_for('main.home') }}">In√≠cio</a>
                    <a href="{{ url_for('produto.buscar_produtos') }}">Produtos</a>
                    <a href="{{ url_for('produto.adicionar_produtos') }}">Adicionar Produto</a>
                    <a href="{{ url_for('chat.meus_chats') }}">Conversas</a>
                    {% if not current_user.is_authenticated %}
                    <a href="{{ url_for('auth.registrar') }}">Cadastrar</a>
                    {% endif %}
                </div>

                <div class="coluna-rodape">
                    <h4>Suporte/Ajuda</h4>
                    <a href="{{ url_for('main.relatar_bug_page') }}">Central de Ajuda</a>
                    <a href="#" onclick="abrirModalTermos(); return false;">Termos de Uso</a>
                </div>

                <div class="coluna-rodape">
                    <h4>Contatos</h4>
                    <a>üìßcontato@valefeira.com.br</a>
                    <a>üìßsuportevaleefeira@gmail.com</a>
                    <a href="#">üì± (38) 3333-4444</a>
                    <p>üìç Vale do Jequitinhonha, MG</p>
                </div>
            </div>

            <div class="rodape-inferior">
                &copy; 2026 Vale&Feira. Todos os direitos reservados.
            </div>
        </footer>

        <div id="modalTermos" class="modal">
            <div class="conteudo-modal">
                <span class="btn-fechar" onclick="fecharModalTermos()">&times;</span>
                <div class="corpo-modal">
                    <h3>Termos e Condi√ß√µes de Uso</h3>
                    <h4>1. Objeto e Defini√ß√£o</h4>
                    <p>
                        A plataforma Vale & Feira √© um ambiente digital destinado √† divulga√ß√£o,
                        promo√ß√£o e facilita√ß√£o da comercializa√ß√£o de produtos cultivados e
                        produzidos no Vale do Jequitinhonha. O site atua como uma "feira virtual",
                        conectando produtores locais (agricultores familiares e artes√£os) a potenciais compradores.
                    </p>

                    <h4>2. Natureza do Servi√ßo (Intermedia√ß√£o de Contato)</h4>
                    <ul>
                        <li><strong>Divulga√ß√£o:</strong> A plataforma oferece espa√ßo para que o produtor cadastre produtos com fotos, descri√ß√£o e pre√ßo.</li>
                        <li><strong>Aus√™ncia de Intermedi√°rios:</strong> O Vale & Feira n√£o realiza a venda direta nem processa pagamentos (nesta vers√£o MVP). A plataforma facilita o contato via WhatsApp ou e-mail, sendo a transa√ß√£o comercial de inteira responsabilidade das partes envolvidas.</li>
                    </ul>

                    <h4>3. Responsabilidades do Produtor (Vendedor)</h4>
                    <p>Ao cadastrar um produto, o usu√°rio produtor garante que:</p>
                    <ul>
                        <li>As informa√ß√µes sobre o produto (origem, peso, tipo de cultivo) s√£o verdadeiras.</li>
                        <li>As imagens postadas correspondem fielmente ao produto ofertado.</li>
                        <li>Possui autoriza√ß√£o legal para comercializar os itens listados.</li>
                        <li>Compromete-se a manter seus dados de contato atualizados para viabilizar a negocia√ß√£o.</li>
                    </ul>

                    <h4>4. Responsabilidades do Consumidor (Comprador)</h4>
                    <p>O usu√°rio interessado em adquirir produtos reconhece que:</p>
                    <ul>
                        <li>A plataforma n√£o garante a log√≠stica de entrega, que deve ser combinada diretamente com o produtor.</li>
                        <li>A verifica√ß√£o da qualidade e proced√™ncia do produto no ato da entrega √© de sua responsabilidade.</li>
                    </ul>

                    <h4>5. Propriedade Intelectual e Identidade Regional</h4>
                    <p>
                        Todo o conte√∫do institucional, logotipos e a estrutura do site s√£o de propriedade da
                        Equipe de Desenvolvimento Vale & Feira. A plataforma visa valorizar as tradi√ß√µes e a
                        identidade do Vale do Jequitinhonha.
                    </p>

                    <h4>6. Limita√ß√£o de Responsabilidade</h4>
                    <p>A equipe Vale & Feira n√£o se responsabiliza por:</p>
                    <ul>
                        <li>Negocia√ß√µes frustradas ou n√£o concretizadas entre usu√°rios.</li>
                        <li>Diverg√™ncias de pre√ßos ou qualidade de produtos.</li>
                        <li>Eventuais problemas no transporte ou perecibilidade de alimentos ap√≥s a sa√≠da da propriedade rural.</li>
                    </ul>

                    <h4>7. Prote√ß√£o de Dados (LGPD)</h4>
                    <p>
                        Em conformidade com a Lei Geral de Prote√ß√£o de Dados, os dados coletados (nome, e-mail,
                        telefone e localiza√ß√£o) ser√£o utilizados exclusivamente para autentica√ß√£o, exibi√ß√£o p√∫blica
                        (no caso de produtores) e seguran√ßa da plataforma.
                    </p>

                    <h4>8. Canal de √âtica e Den√∫ncias</h4>
                    <p>
                        Reservamo-nos o direito de remover an√∫ncios ou suspender contas que apresentem comportamentos abusivos,
                        informa√ß√µes falsas ou que desrespeitem os princ√≠pios da agricultura familiar e economia solid√°ria.
                    </p>

                    <div class="centralizado-mt20">
                        <button class="botao-fechar-modal" onclick="fecharModalTermos()">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function toggleFiltros() {
                var painel = document.getElementById("painelFiltros");
                painel.classList.toggle("aberto");
            }

            function abrirModalTermos() {
                document.getElementById("modalTermos").style.display = "flex";
            }
            function fecharModalTermos() {
                document.getElementById("modalTermos").style.display = "none";
            }
            window.onclick = function (event) {
                if (event.target == document.getElementById("modalTermos")) {
                    fecharModalTermos();
                }
            };
        </script>
    </body>
</html>
